{ config, lib, pkgs, ... }:

{
  home.file.".config/zsh/".source = ../../config/zsh;
  home.file.".config/zsh/".recursive = true;

  programs.zsh = {
    enable = true;
    autocd = false;
    dotDir = ".config/zsh";
    enableCompletion = true;

    # manually setting these to over-ride defaults, further not pkg supported options in initExtra
    history = {
    path = "$ZDOTDIR/zsh_history";
    size = 100000;
    save = 100000;
    extended = true;
    expireDuplicatesFirst = true;
    ignoreAllDups = true;
    ignoreSpace = true;
  };
    envExtra = ''
      # This file is autogenerated, do not edit it!
      echo "[DEBUG] envExtra: Setting restrictive umask permissions."

      export ZDOTDIR="$HOME/.config/zsh"
      echo "[DEBUG] envExtra: ZDOTDIR is set to $ZDOTDIR."
   
   # Be more restrictive with permissions in $HOME; no one has any business
      # reading things that don't belong to them.
      if (( EUID != 0 )); then
        umask 027
        echo "[DEBUG] envExtra: Non-root umask set to 027."
      else
        # Be even less permissive if root.
        umask 077
        echo "[DEBUG] envExtra: Root umask set to 077."
      fi
    '';
    initExtraBeforeCompInit = ''
      echo "[DEBUG] initExtraBeforeCompInit: Loading config.zsh and completion.zsh."
      source $ZDOTDIR/config.zsh
      echo "[DEBUG] initExtraBeforeCompInit: config.zsh loaded."
      source $ZDOTDIR/completion.zsh
      echo "[DEBUG] initExtraBeforeCompInit: completion.zsh loaded."
    '';
    completionInit = ''
      echo "[DEBUG] completionInit: Starting Zsh completion initialization."

      # Only generate the dump if it doesn't exist. `hey reload` will clear it. And
      # yes, -d is necessary. compinit doesn't respect cache-path.
      ZCOMPCACHE="$XDG_CACHE_HOME/zsh/zcompdump.$ZSH_VERSION"
      if autoload -Uz compinit; then
        compinit -u -C -d "$ZCOMPCACHE"
        echo "[DEBUG] completionInit: Compinit executed."
        [[ ! -f "$ZCOMPCACHE.zwc" && -f $ZCOMPCACHE ]] && zcompile "$ZCOMPCACHE"
        echo "[DEBUG] completionInit: Zsh completion cache compiled."
      fi
    '';
    initExtra = ''
    setopt BANG_HIST               # History expansions on '!'
    setopt INC_APPEND_HISTORY        # Write to the history file immediately, not when the shell exits.
    setopt HIST_FIND_NO_DUPS         # Do not display a previously found event.
    setopt HIST_SAVE_NO_DUPS         # Do not write a duplicate event to the history file.
    setopt HIST_REDUCE_BLANKS        # Minimize unnecessary whitespace
    setopt HIST_VERIFY               # Do not execute immediately upon history expansion.
    setopt HIST_BEEP                 # Beep when accessing non-existent history.

      echo "[DEBUG] initExtra: Loading aliases.zsh, keybinds.zsh, and p10k.zsh."
      source $ZDOTDIR/aliases.zsh
      echo "[DEBUG] initExtra: aliases.zsh loaded."
      source $ZDOTDIR/keybinds.zsh
      echo "[DEBUG] initExtra: keybinds.zsh loaded."
      source $ZDOTDIR/p10k.zsh
      echo "[DEBUG] initExtra: p10k.zsh loaded."

      unset ZSH_AUTOSUGGEST_USE_ASYNC
      echo "[DEBUG] initExtra: ZSH_AUTOSUGGEST_USE_ASYNC unset."
    '';
  };  
    #programs.fzf = {
    #enable = true;
    #enableZshIntegration = true;
    #};
}

