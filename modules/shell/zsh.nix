{ config, lib, pkgs, ... }:

{
  home.file.".config/zsh/".source = ../../config/zsh;
  home.file.".config/zsh/".recursive = true;

  programs.zsh = {
    enable = true;
    autocd = false;
    dotDir = ".config/zsh";
    enableCompletion = true;

    # manually setting these to over-ride defaults, further not pkg supported options in initExtra
    history = {
    path = "$ZDOTDIR/zsh_history";
    size = 100000;
    save = 100000;
    extended = true;
    expireDuplicatesFirst = true;
    ignoreAllDups = true;
    ignoreSpace = true;
  };
    envExtra = ''
      # This file is autogenerated, do not edit it!
      export ZDOTDIR="$HOME/.config/zsh"
   
      # Be more restrictive with permissions in $HOME; no one has any business
      # reading things that don't belong to them.
      if (( EUID != 0 )); then
        umask 027
      else
        # Be even less permissive if root.
        umask 077
      fi
    '';
    initExtraBeforeCompInit = ''
      source $ZDOTDIR/config.zsh
      source $ZDOTDIR/completion.zsh
    '';
    completionInit = ''
      # Only generate the dump if it doesn't exist. `hey reload` will clear it. And
      # yes, -d is necessary. compinit doesn't respect cache-path.
      ZCOMPCACHE="$XDG_CACHE_HOME/zsh/zcompdump.$ZSH_VERSION"
      if autoload -Uz compinit; then
        compinit -u -C -d "$ZCOMPCACHE"
        [[ ! -f "$ZCOMPCACHE.zwc" && -f $ZCOMPCACHE ]] && zcompile "$ZCOMPCACHE"
      fi
    '';
    initExtra = ''
    setopt BANG_HIST               # History expansions on '!'
    setopt INC_APPEND_HISTORY        # Write to the history file immediately, not when the shell exits.
    setopt HIST_FIND_NO_DUPS         # Do not display a previously found event.
    setopt HIST_SAVE_NO_DUPS         # Do not write a duplicate event to the history file.
    setopt HIST_REDUCE_BLANKS        # Minimize unnecessary whitespace
    setopt HIST_VERIFY               # Do not execute immediately upon history expansion.
    setopt HIST_BEEP                 # Beep when accessing non-existent history.
      source $ZDOTDIR/aliases.zsh
      source $ZDOTDIR/keybinds.zsh
      source $ZDOTDIR/p10k.zsh
      unset ZSH_AUTOSUGGEST_USE_ASYNC
    '';
  };  
    #programs.fzf = {
    #enable = true;
    #enableZshIntegration = true;
    #};
}

