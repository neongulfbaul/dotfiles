{ config, lib, pkgs, ... }:

let
  zshEarly = lib.mkOrder 500 ''
    source $ZDOTDIR/config.zsh
  '';

  zshGeneral = lib.mkOrder 1000 ''
    setopt BANG_HIST
    setopt INC_APPEND_HISTORY
    setopt HIST_FIND_NO_DUPS
    setopt HIST_SAVE_NO_DUPS
    setopt HIST_REDUCE_BLANKS
    setopt HIST_VERIFY
    setopt HIST_BEEP
    source $ZDOTDIR/aliases.zsh
    source $ZDOTDIR/keybinds.zsh
    source $ZDOTDIR/p10k.zsh
    unset ZSH_AUTOSUGGEST_USE_ASYNC
  '';

  zshCompletion = lib.mkOrder 1500 ''
    source $ZDOTDIR/completion.zsh
    ZCOMPCACHE="$XDG_CACHE_HOME/zsh/zcompdump.$ZSH_VERSION"
    if autoload -Uz compinit; then
      compinit -u -C -d "$ZCOMPCACHE"
      [[ ! -f "$ZCOMPCACHE.zwc" && -f $ZCOMPCACHE ]] && zcompile "$ZCOMPCACHE"
    fi
  '';
in
{
  home.file.".config/zsh/".source = ../config/zsh; 
  home.file.".config/zsh/".recursive = true; 
  
  programs.zsh = {
    enable = true;
    autocd = false;
    dotDir = config.home.homeDirectory + "/.config/zsh";
    enableCompletion = true;

    history = {
      path = "$ZDOTDIR/zsh_history";
      size = 100000;
      save = 100000;
      extended = true;
      expireDuplicatesFirst = true;
      ignoreAllDups = true;
      ignoreSpace = true;
    };

    envExtra = ''
      # This file is autogenerated, do not edit it!
      export ZDOTDIR="$HOME/.config/zsh"

      if (( EUID != 0 )); then
        umask 027
      else
        umask 077
      fi
    '';
  initContent = lib.mkMerge [ zshEarly zshGeneral zshCompletion ];


  };
}
